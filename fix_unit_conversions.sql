-- แก้ไขปัญหา Duplicate Entry ในตาราง unit_conversions
USE esp_tracker;

-- 1. ลบ unique constraint เดิม
ALTER TABLE unit_conversions 
DROP INDEX unique_conversion;

-- 2. เพิ่มคอลัมน์ Mat_Id
ALTER TABLE unit_conversions 
ADD COLUMN Mat_Id VARCHAR(16) DEFAULT NULL;

-- 3. สร้าง unique constraint ใหม่ที่รวม Mat_Id
ALTER TABLE unit_conversions 
ADD UNIQUE KEY unique_conversion (from_unit, to_unit, Mat_Id);

-- 4. ลบข้อมูลเก่า (ถ้ามี)
DELETE FROM unit_conversions WHERE from_unit = 'แพ็ค';

-- 5. เพิ่มข้อมูล conversion rates ใหม่ (รวม Mat_Id)
INSERT INTO unit_conversions (from_unit, to_unit, conversion_rate, description, material_name, material_pattern, Mat_Id) VALUES
-- Mala Paste ต่างๆ (ตามชื่อวัตถุดิบจริง)
('แพ็ค', 'กก.', 0.150, '1 แพ็ค = 0.150 กก. (150 กรัม)', 'Mala Paste (SanWu)', 'SanWu', 'MP001'),
('แพ็ค', 'กก.', 0.200, '1 แพ็ค = 0.200 กก. (200 กรัม)', 'Mala Paste (ให้ตี๋เหล่า)', 'ให้ตี๋เหล่า', 'MP002'),
('แพ็ค', 'กก.', 0.180, '1 แพ็ค = 0.180 กก. (180 กรัม)', 'Mala Paste ทั่วไป', 'Mala Paste', 'MP003'),

-- วัตถุดิบอื่นๆ ที่ใช้หน่วยแพ็ค
('แพ็ค', 'กก.', 0.100, '1 แพ็ค = 0.100 กก. (100 กรัม)', 'เครื่องปรุงทั่วไป', 'เครื่องปรุง', 'SP001'),
('แพ็ค', 'กก.', 0.250, '1 แพ็ค = 0.250 กก. (250 กรัม)', 'วัตถุดิบหนัก', 'หนัก', 'SP002'),
('แพ็ค', 'กก.', 0.300, '1 แพ็ค = 0.300 กก. (300 กรัม)', 'วัตถุดิบหนักพิเศษ', 'หนักพิเศษ', 'SP003'),

-- วัตถุดิบที่ใช้หน่วยกล่อง
('กล่อง', 'กก.', 0.500, '1 กล่อง = 0.500 กก. (500 กรัม)', 'กล่องเล็ก', 'เล็ก', 'BX001'),
('กล่อง', 'กก.', 1.000, '1 กล่อง = 1.000 กก. (1 กก.)', 'กล่องกลาง', 'กลาง', 'BX002'),
('กล่อง', 'กก.', 2.000, '1 กล่อง = 2.000 กก. (2 กก.)', 'กล่องใหญ่', 'ใหญ่', 'BX003'),

-- วัตถุดิบที่ใช้หน่วยชิ้น
('ชิ้น', 'กก.', 0.100, '1 ชิ้น = 0.100 กก. (100 กรัม)', 'ชิ้นเล็ก', 'เล็ก', 'PC001'),
('ชิ้น', 'กก.', 0.150, '1 ชิ้น = 0.150 กก. (150 กรัม)', 'ชิ้นกลาง', 'กลาง', 'PC002'),
('ชิ้น', 'กก.', 0.200, '1 ชิ้น = 0.200 กก. (200 กรัม)', 'ชิ้นใหญ่', 'ใหญ่', 'PC003'),

-- วัตถุดิบที่ใช้หน่วยขวด
('ขวด', 'กก.', 0.500, '1 ขวด = 0.500 กก. (500 มล.)', 'ขวดเล็ก', 'เล็ก', 'BT001'),
('ขวด', 'กก.', 1.000, '1 ขวด = 1.000 กก. (1 ลิตร)', 'ขวดใหญ่', 'ใหญ่', 'BT002'),

-- วัตถุดิบที่ใช้หน่วยกระปุก
('กระปุก', 'กก.', 0.200, '1 กระปุก = 0.200 กก. (200 กรัม)', 'กระปุกเล็ก', 'เล็ก', 'JB001'),
('กระปุก', 'กก.', 0.300, '1 กระปุก = 0.300 กก. (300 กรัม)', 'กระปุกกลาง', 'กลาง', 'JB002'),
('กระปุก', 'กก.', 0.500, '1 กระปุก = 0.500 กก. (500 กรัม)', 'กระปุกใหญ่', 'ใหญ่', 'JB003'),

-- วัตถุดิบที่ใช้หน่วยถุง
('ถุง', 'กก.', 0.100, '1 ถุง = 0.100 กก. (100 กรัม)', 'ถุงเล็ก', 'เล็ก', 'BG001'),
('ถุง', 'กก.', 0.250, '1 ถุง = 0.250 กก. (250 กรัม)', 'ถุงกลาง', 'กลาง', 'BG002'),
('ถุง', 'กก.', 0.500, '1 ถุง = 0.500 กก. (500 กรัม)', 'ถุงใหญ่', 'ใหญ่', 'BG003'),
('ถุง', 'กก.', 1.000, '1 ถุง = 1.000 กก. (1 กก.)', 'ถุงใหญ่พิเศษ', 'ใหญ่พิเศษ', 'BG004'),

-- วัตถุดิบที่ใช้หน่วยซอง
('ซอง', 'กก.', 0.050, '1 ซอง = 0.050 กก. (50 กรัม)', 'ซองเล็ก', 'เล็ก', 'PK001'),
('ซอง', 'กก.', 0.100, '1 ซอง = 0.100 กก. (100 กรัม)', 'ซองกลาง', 'กลาง', 'PK002'),
('ซอง', 'กก.', 0.150, '1 ซอง = 0.150 กก. (150 กรัม)', 'ซองใหญ่', 'ใหญ่', 'PK003'),

-- วัตถุดิบที่ใช้หน่วยขวดเล็ก
('ขวดเล็ก', 'กก.', 0.250, '1 ขวดเล็ก = 0.250 กก. (250 มล.)', 'ขวดเล็ก', 'เล็ก', 'SB001'),
('ขวดเล็ก', 'กก.', 0.300, '1 ขวดเล็ก = 0.300 กก. (300 มล.)', 'ขวดเล็ก', 'กลาง', 'SB002'),

-- วัตถุดิบที่ใช้หน่วยกระป๋อง
('กระป๋อง', 'กก.', 0.400, '1 กระป๋อง = 0.400 กก. (400 กรัม)', 'กระป๋องเล็ก', 'เล็ก', 'CN001'),
('กระป๋อง', 'กก.', 0.500, '1 กระป๋อง = 0.500 กก. (500 กรัม)', 'กระป๋องใหญ่', 'ใหญ่', 'CN002'),

-- วัตถุดิบที่ใช้หน่วยถ้วย
('ถ้วย', 'กก.', 0.200, '1 ถ้วย = 0.200 กก. (200 กรัม)', 'ถ้วยเล็ก', 'เล็ก', 'CP001'),
('ถ้วย', 'กก.', 0.300, '1 ถ้วย = 0.300 กก. (300 กรัม)', 'ถ้วยใหญ่', 'ใหญ่', 'CP002');

-- 6. ตรวจสอบข้อมูลที่เพิ่ม
SELECT * FROM unit_conversions ORDER BY from_unit, material_name, conversion_rate;

-- 7. แสดงโครงสร้างตาราง
DESCRIBE unit_conversions;
